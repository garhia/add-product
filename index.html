<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>
  <main>
    <div class="hide" id='loadingDiv'>
      <img src='./images/loading.svg' height="200px" , width="200px" />
    </div>
    <div class="hide" id="success">
      <img src="./images/success.webp" height="30px" width="30px" />
      <p> Successfully added products</p>
    </div>
    <form onsubmit="event.preventDefault()">

      <div id="top-div" class="form-group">
        <label>
          Medical Name
        </label><br />
        <input type="text" id="medicalName" required />
      </div>

      <div id="low-div">
        <div class="form-group low-field">
          <label>
            Product Name
          </label><br />
          <input type="text" id="productName" required />
        </div>

        <div class="form-group low-field">
          <label>
            Company Name
          </label><br />
          <input type="text" id="companyName" required />
        </div>


        <div class="form-group low-field">
          <label>
            product Form
          </label> <br />
          <select id="form">
            <option value="Syrup">Syrup</option>
            <option value="Tablet">Tablet</option>
            <option value="Caplet"> Caplet </option>
            <option value="Capsule"> Capsule</option>
            <option value="injection"> Injection</option>
            <option value="Oral Suspension">Oral Suspension</option>
            <option value="Ointment">Ointment</option>
            <option value="Liniment">Liniment</option>
            <option value="Cream">Cream</option>
            <option value="Spray">Spray</option>
            <option value="Lotion">Lotion</option>
            <option value="Gel">Gel</option>
            <option value="Plaster">Plaster</option>
            <option value="Liquid">Liquid</option>
            <option value="Oral drip">Oral drip</option>
            <option value="Oral liquid">Oral liquid</option>
            <option value="Suppository">Suppository</option>
            <option value="Granules">Granules</option>
            <option value="Powder">Powder</option>
            <option value="Oral drops">Oral drops</option>
          </select>
        </div>

        <div class="form-group low-field">
          <button class="add-btn" onclick="addProduct()">
            <img src='images/add.svg' height="60" width="60" />
          </button>
        </div>

      </div>

      <div class="product-container">
        <h2 class="p-header">
          Products
        </h2>
        <div id="products">

        </div>
      </div>
      <input type="submit" value="Submit" id="submitBtn" onclick="createProducts()" />
    </form>
  </main>


  <script>
      let products = {};
      const prouctNameInput = document.getElementById('productName');
      const medicalNameInput = document.getElementById('medicalName');
      const companyNameInput = document.getElementById('companyName');
      const formInput = document.getElementById('form');

      const submitBtn = document.getElementById('submitBtn');

      function createProducts() {
        const success = document.getElementById('success');
        const loader = document.getElementById('loadingDiv');
        loader.classList.remove('hide');
        loader.classList.add('loadingDiv');
        submitBtn.disabled = true;
        const postProducts = Object.values(products);
        fetch('https://pharm-pro.herokuapp.com/api/products/many', {
          method: 'post',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postProducts.flat())
        }).then(res => res.json()).then(result => {
          console.log(result);
          prouctNameInput.value = '';
          medicalNameInput.value = '';
          companyNameInput.value = '';
          success.classList.remove('hide');
          success.classList.add('success');
          setTimeout(() => {
            success.classList.remove('success');
            success.classList.add('hide');
          }, 2000);
          products = {};
          createProductDiv();
          submitBtn.disabled = false;
          loader.classList.remove('loadingDiv');
          loader.classList.add('hide');
        }).catch(e => {
          console.log('edjhedÃŸ')
          console.log(e);
        })
      }
  
      function addProduct() {
        const drug = {
          name: prouctNameInput.value,
          medicalName: medicalNameInput.value,
          companyName: companyNameInput.value,
          form: formInput.value,
        }
        if(drug.name && drug.medicalName && drug.companyName && drug.form){
          products[drug.medicalName] = products[drug.medicalName] || [];
          products[drug.medicalName].push(drug);
          createProductDiv();
          companyNameInput.value = '';
          prouctNameInput.value = '';
        }        
      }
  
      function createProductDiv() {
        const productDiv = document.getElementById('products');
        productDiv.innerHTML = '';
        Object.keys(products).forEach(medName => {
          if(products[medName].length > 0){
            const divCon = document.createElement('div');
            const medP = document.createElement('p');
            medP.classList.add('med-row')
            medP.innerHTML = medName;
            const hr = document.createElement('hr');
            divCon.appendChild(medP);
            divCon.appendChild(hr);
            products[medName].forEach(ele => {
              const productRow = document.createElement('div');

              productRow.classList.add('row');
              const colOne = document.createElement('p');
              const colTwo = document.createElement('p');
              const colThree = document.createElement('p');

              colOne.innerHTML = ele.name
              colOne.classList.add('row-col');

              colTwo.innerHTML = ele.companyName;
              colTwo.classList.add('row-col');

              colThree.innerHTML = ele.form;
              colThree.classList.add('row-col');

              productRow.appendChild(colOne);
              productRow.appendChild(colTwo);
              productRow.appendChild(colThree);

              divCon.appendChild(productRow)
            })
            productDiv.appendChild(divCon);
          }
        })
      }
  
      createProductDiv();
    </script>
</body>

</html>
